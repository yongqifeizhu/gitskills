<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>demo</title>
		<script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
		<script src="http://jssdk-v2.demo.qiniu.io/dist/qiniu.min.js"></script>
	</head>
	<body>
		<!-- <a href="http://socket.wzmeilv.com/other/wza.pdf" target="view_window">无障碍停车介绍</a>
		<a href="http://socket.wzmeilv.com/other/cws.pdf" target="view_window">物联网车位锁介绍</a>
		<a href="http://socket.wzmeilv.com/other/dz.pdf" target="view_window">智能道闸产品介绍</a> -->
		<input type="file" name="image" id="file" accept="image/*">
    <input type="button" id="upload" value="upload">
    <img id="image" src="#" alt="">
	</body>
	<script type="text/javascript">
		$(function () {
        $("#upload").on("click", function () {
            var obj = $("#file");
            var fileName = obj.val();		                                           //上传的本地文件绝对路径
            var suffix = fileName.substring(fileName.lastIndexOf("."),fileName.length);//后缀名
            var file = obj.get(0).files[0];	                                           //上传的文件
            var size = file.size > 1024 ? file.size / 1024 > 1024 ? file.size / (1024 * 1024) > 1024 ? (file.size / (1024 * 1024 * 1024)).toFixed(2) + 'GB' : (file.size
                / (1024 * 1024)).toFixed(2) + 'MB' : (file.size
                / 1024).toFixed(2) + 'KB' : (file.size).toFixed(2) + 'B';		   //文件上传大小
            //七牛云上传
            console.log(fileName.substring(fileName.lastIndexOf("."),fileName.length))
            console.log(file)
            $.ajax({
                type:'post',
                url: "http://10.0.11.63:8080/positioner/up/QiniuUpToken",
                data:{"suffix":suffix},
                dataType:'json',
                success: function(result){
                    console.log(result)
                    if(result.resCode == 0){
                       
                        var observer = {                         //设置上传过程的监听函数
                            next(result){                        //上传中(result参数带有total字段的 object，包含loaded、total、percent三个属性)
                                Math.floor(result.total.percent);//查看进度[loaded:已上传大小(字节);total:本次上传总大小;percent:当前上传进度(0-100)]
                            },
                            error(err){                          //失败后
                                alert(err.message);
                            },
                            complete(res){
                                console.log(result.domain+result.imgUrl)                     //成功后
                                // ?imageView2/2/h/100：展示缩略图，不加显示原图
                                // ?vframe/jpg/offset/0/w/480/h/360：用于获取视频截图的后缀，0：秒，w：宽，h：高
                                $("#image").attr("src",result.domain+result.imgUrl);
                            }
                        };
                        var putExtra = {
                            fname: "",                          //原文件名
                            params: {},                         //用来放置自定义变量
                            mimeType: null                      //限制上传文件类型
                        };
                        var config = {
                            region:qiniu.region.z2,             //存储区域(z0:代表华东;z2:代表华南,不写默认自动识别)
                            concurrentRequestLimit:3            //分片上传的并发请求量
                        };
                        var observable = qiniu.upload(file,result.imgUrl,result.token,putExtra,config);
                        var subscription = observable.subscribe(observer);          // 上传开始
                        // 取消上传
                        // subscription.unsubscribe();
                    }else{
                        alert(result.message);                  //获取凭证失败
                    }
                },error:function(){                             //服务器响应失败处理函数
                    alert("服务器繁忙");
                }
            });
        })
    })
    </script>
<script>
    // 	@Controller
// public class QiniuUpload {
//     // ******的内容需要查看七牛云账号的相关信息
//     private static final String accessKey = "******";    //访问秘钥
//     private static final String secretKey = "******";    //授权秘钥
//     private static final String bucket = "******";       //存储空间名称
//     private static final String domain = "******";       //外链域名

//     /**
//      * 七牛云上传生成凭证
//      *
//      * @throws Exception
//      */
//     @RequestMapping("/QiniuUpToken")
//     @ResponseBody
//     public Map<String, Object> QiniuUpToken(@RequestParam String suffix) throws Exception{
//         Map<String, Object> result = new HashMap<String, Object>();
//         try {
//             //验证七牛云身份是否通过
//             Auth auth = Auth.create(accessKey, secretKey);
//             //生成凭证
//             String upToken = auth.uploadToken(bucket);
//             result.put("token", upToken);
//             //存入外链默认域名，用于拼接完整的资源外链路径
//             result.put("domain", domain);

//             // 是否可以上传的图片格式
//             /*boolean flag = false;
//             String[] imgTypes = new String[]{"jpg","jpeg","bmp","gif","png"};
//             for(String fileSuffix : imgTypes) {
//                 if(suffix.substring(suffix.lastIndexOf(".") + 1).equalsIgnoreCase(fileSuffix)) {
//                     flag = true;
//                     break;
//                 }
//             }
//             if(!flag) {
//                 throw new Exception("图片：" + suffix + " 上传格式不对！");
//             }*/

//             //生成实际路径名
//             String randomFileName = UUID.randomUUID().toString() + suffix;
//             result.put("imgUrl", randomFileName);
//             result.put("success", 1);
//         } catch (Exception e) {
//             result.put("message", "获取凭证失败，"+e.getMessage());
//             result.put("success", 0);
//         } finally {
//             return result;
//         }
//     }
// }
</script>
</html>
